<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Round Timer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #111827; 
            --bg-secondary: #1f2937; 
            --bg-tertiary: #374151; 
            --bg-accent: #4b5563; 
            --text-primary: #f9fafb; 
            --text-secondary: #d1d5db; 
            --text-accent: #6b7280; 
            
            --color-warm-up: #f59e0b;
            --color-prepare: #facc15;
            --color-work: #C51E3A;    
            --color-rest: #4ade80;    
            --color-set-rest: #2dd4bf;
            
            --btn-primary: #3b82f6; 
            --btn-secondary: #ef4444; 
            --btn-start: #22c55e; 
            --btn-save: #f59e0b; 
            --btn-rename: #8b5cf6; 
        }

        body {
            font-family: 'Inter', sans-serif;
            touch-action: manipulation;
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }
        
        #timer-container {
            transition: background-color 0.5s ease, color 0.3s ease;
            border: 4px solid rgba(255, 255, 255, 0.1); 
        }

        .timer-display { font-weight: 900; line-height: 1; }
        .btn { transition: all 0.2s ease; }
        .btn:active { transform: scale(0.95); }
        
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        .panel { transition: opacity 0.3s ease, transform 0.3s ease; }
        .panel.hidden { display: none; }
        
        .custom-select {
            -webkit-appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg fill="white" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 0.7rem center;
            background-size: 1.2em;
            padding-right: 2.5rem;
        }

        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--bg-accent); transition: .4s; border-radius: 28px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--btn-start); }
        input:checked + .slider:before { transform: translateX(22px); }

        #progress-bar-container { width: 100%; height: 12px; background-color: rgba(255, 255, 255, 0.2); border-radius: 6px; overflow: hidden; margin-top: 1rem; }
        #progress-bar { height: 100%; background-color: currentColor; width: 100%; transition: width 1s linear; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-md mx-auto">
        <div id="timer-container" class="rounded-2xl shadow-2xl p-6 relative panel" style="background-color: var(--bg-secondary);">
            <div id="display-area" class="text-center mb-4 relative h-auto py-8 flex flex-col items-center justify-center rounded-xl">
                <div id="timer-display-content" class="z-0 w-full px-4">
                    <div id="phase-display" class="text-3xl font-bold uppercase mb-2">Prepare</div>
                    <div id="timer-display" class="text-8xl md:text-9xl timer-display tracking-tight tabular-nums">--:--</div>
                    <div id="progress-bar-container"><div id="progress-bar"></div></div>
                    <div id="progress-display" class="text-xl mt-6 flex items-center justify-center gap-6">
                        <button id="skip-back-btn" class="p-2 rounded-full hover:bg-white hover:bg-opacity-20 btn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m15 18-6-6 6-6"/></svg>
                        </button>
                        <div class="flex flex-col items-center leading-tight">
                            <span>Round <span id="current-round" class="font-bold">0</span>/<span id="total-rounds">0</span></span>
                            <span class="text-xl opacity-80">Set <span id="current-set">0</span>/<span id="total-sets">0</span></span>
                        </div>
                        <button id="skip-forward-btn" class="p-2 rounded-full hover:bg-white hover:bg-opacity-20 btn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m9 18 6-6-6-6"/></svg>
                        </button>
                    </div>
                </div>
                <div id="completion-message" class="hidden"><h2 class="text-4xl font-extrabold">Done!</h2></div>
            </div>
            
            <div id="exercise-display-container" class="text-center mb-4 p-3 rounded-lg" style="background-color: rgba(0,0,0,0.2);">
                <h4 class="text-sm font-semibold uppercase opacity-75">Current</h4>
                <p id="exercise-display" class="text-2xl font-bold truncate">---</p>
            </div>
            
            <div class="mb-4">
                <select id="main-preset-select" class="custom-select w-full font-bold py-3 px-4 rounded-lg text-lg" style="background-color: rgba(0,0,0,0.2); color: inherit; border:none;"></select>
            </div>

            <div id="controls-container" class="grid grid-cols-3 gap-4">
                <button id="start-pause-btn" class="font-bold py-3 rounded-lg text-lg btn" style="background-color: var(--btn-start);">Start</button>
                <button id="reset-btn" class="font-bold py-3 rounded-lg text-lg btn" style="background-color: var(--btn-secondary);">Reset</button>
                <button id="settings-btn" class="font-bold py-3 rounded-lg text-lg btn" style="background-color: var(--btn-primary);">Settings</button>
            </div>
        </div>

        <div id="settings-panel" class="rounded-2xl shadow-2xl p-6 hidden panel" style="background-color: var(--bg-secondary);">
            <div id="main-settings-content">
                <h3 class="text-2xl font-bold mb-6 text-center">Settings</h3>
                <div id="timer-inputs-container" class="grid grid-cols-2 gap-4 mb-6"></div>
                <div class="mb-6 p-4 rounded-lg flex justify-between items-center" style="background-color: var(--bg-tertiary);">
                    <span class="font-bold">Warm up</span>
                    <label class="toggle-switch"><input type="checkbox" id="warm-up-toggle"><span class="slider"></span></label>
                </div>
                <select id="preset-select" class="custom-select w-full py-3 px-4 rounded-lg mb-4" style="background-color: var(--bg-tertiary); border:none;"></select>
                <div class="grid grid-cols-2 gap-2 mb-4">
                    <button id="exercise-settings-btn" class="py-3 rounded-lg btn" style="background-color: var(--bg-accent);">Exercises</button>
                    <button id="update-preset-btn" class="py-3 rounded-lg btn" style="background-color: var(--btn-save);">Save Current</button>
                </div>
                <button id="close-settings-btn" class="w-full py-3 rounded-lg btn" style="background-color: var(--btn-start);">Done</button>
            </div>
        </div>

        <div id="exercise-settings-panel" class="rounded-2xl shadow-2xl p-6 hidden panel" style="background-color: var(--bg-secondary);">
            <h3 class="text-xl font-bold mb-4 text-center">Exercises & Rounds</h3>
            <div id="exercise-inputs-container" class="space-y-3 max-h-96 overflow-y-auto pr-2"></div>
            <button id="back-to-settings-from-exercises-btn" class="mt-6 w-full py-3 rounded-lg btn" style="background-color: var(--btn-primary);">Back</button>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const getElem = (id) => document.getElementById(id);
    const createExercise = (name, rounds) => ({ name, rounds });

    // --- INITIAL DATA ---
    const defaultPresets = {
        "Athletic": {
            workTime: 35, restTime: 35, numSets: 6, restBetweenSets: 75, warmUpDuration: 300,
            exercises: [
                createExercise("Kettlebell OHP", 6), createExercise("Kettlebell row", 6),
                createExercise("Woodchoppers", 6), createExercise("SL squat", 4),
                createExercise("SL Deadlift", 6), createExercise("Kettlebell swing", 4)
            ]
        },
        "Sturdy": {
            workTime: 35, restTime: 35, numSets: 7, restBetweenSets: 75, warmUpDuration: 300,
            exercises: [
                createExercise("Dumbell rows", 4), createExercise("Dumbell OHP", 4),
                createExercise("Kettlebell squat", 3), createExercise("Kettlebell lateral squat", 6),
                createExercise("Split squat", 6), createExercise("Kettlebell windmill", 3),
                createExercise("Hip flexors", 4)
            ]
        },
        "Access": {
            workTime: 35, restTime: 35, numSets: 7, restBetweenSets: 75, warmUpDuration: 300,
            exercises: [
                createExercise("Glute medius plate", 1), createExercise("Kettlebell halos", 1),
                createExercise("Power twister", 1), createExercise("Forearms", 1),
                createExercise("Neck", 1), createExercise("Abs", 1),
                createExercise("Running man + hammer curls", 1)
            ]
        },
        "Thasmin": {
            workTime: 35, restTime: 35, numSets: 7, restBetweenSets: 75, warmUpDuration: 300,
            exercises: [
                createExercise("Kettlebell power cleans", 3), createExercise("Kettlebell swings", 3), 
                createExercise("Split squat", 3), createExercise("Squat", 3), 
                createExercise("Hip thrust", 3), createExercise("Monster walk", 3), 
                createExercise("Resistance band row", 3)
            ]
        }
    };

    let state = {
        status: 'idle',
        phase: 'prepare',
        currentTime: 0,
        currentRound: 0,
        currentSet: 0,
        warmUpEnabled: false,
        lastPreset: "Athletic",
        presets: JSON.parse(JSON.stringify(defaultPresets)),
        settings: JSON.parse(JSON.stringify(defaultPresets["Athletic"]))
    };

    let timerInterval = null;
    let audioCtx = null;

    // --- CORE LOGIC ---
    const saveState = () => {
        const data = {
            presets: state.presets,
            settings: state.settings,
            warmUpEnabled: state.warmUpEnabled,
            lastPreset: state.lastPreset
        };
        localStorage.setItem('workoutTimer_v4', JSON.stringify(data));
    };

    const loadState = () => {
        const saved = localStorage.getItem('workoutTimer_v4');
        if (saved) {
            const parsed = JSON.parse(saved);
            state.presets = parsed.presets;
            state.settings = JSON.parse(JSON.stringify(parsed.settings));
            state.warmUpEnabled = parsed.warmUpEnabled;
            state.lastPreset = parsed.lastPreset;
        }
        applySettingsToUI();
    };

    const applySettingsToUI = () => {
        getElem('warm-up-toggle').checked = state.warmUpEnabled;
        generatePresetDropdowns();
        generateTimerInputs();
        updateDisplay();
    };

    const generatePresetDropdowns = () => {
        [getElem('main-preset-select'), getElem('preset-select')].forEach(sel => {
            sel.innerHTML = '';
            Object.keys(state.presets).forEach(p => {
                const opt = document.createElement('option');
                opt.value = p; opt.textContent = p;
                sel.appendChild(opt);
            });
            sel.value = state.lastPreset;
        });
    };

    const handlePresetChange = (name) => {
        state.lastPreset = name;
        // DEEP CLONE FIX: Break the reference link
        state.settings = JSON.parse(JSON.stringify(state.presets[name]));
        applySettingsToUI();
        saveState();
    };

    // --- UI GENERATION ---
    const generateTimerInputs = () => {
        const container = getElem('timer-inputs-container');
        container.innerHTML = '';
        const fields = [
            { id: 'workTime', label: 'Work (s)' },
            { id: 'restTime', label: 'Rest (s)' },
            { id: 'numSets', label: 'Sets' },
            { id: 'restBetweenSets', label: 'Set Rest (s)' }
        ];
        fields.forEach(f => {
            const div = document.createElement('div');
            div.innerHTML = `<label class="block text-xs font-bold opacity-70">${f.label}</label>
                <input type="number" data-id="${f.id}" value="${state.settings[f.id]}" class="w-full bg-gray-900 p-2 rounded border border-gray-700">`;
            div.querySelector('input').addEventListener('input', (e) => {
                state.settings[f.id] = parseInt(e.target.value) || 0;
                saveState();
            });
            container.appendChild(div);
        });
    };

    const generateExerciseInputs = () => {
        const container = getElem('exercise-inputs-container');
        container.innerHTML = '';
        state.settings.exercises.forEach((ex, i) => {
            const div = document.createElement('div');
            div.className = "grid grid-cols-12 gap-2 items-center";
            div.innerHTML = `
                <span class="col-span-1 text-xs opacity-50">${i+1}</span>
                <input type="text" value="${ex.name}" class="col-span-8 bg-gray-800 p-2 rounded text-sm">
                <input type="number" value="${ex.rounds}" class="col-span-3 bg-gray-800 p-2 rounded text-center text-sm">
            `;
            const inputs = div.querySelectorAll('input');
            inputs[0].addEventListener('input', (e) => { state.settings.exercises[i].name = e.target.value; saveState(); });
            inputs[1].addEventListener('input', (e) => { state.settings.exercises[i].rounds = parseInt(e.target.value) || 1; saveState(); });
            container.appendChild(div);
        });
    };

    // --- TIMER ENGINE ---
    const updateDisplay = () => {
        const phaseColors = {
            prepare: 'var(--color-prepare)',
            work: 'var(--color-work)',
            rest: 'var(--color-rest)',
            setRest: 'var(--color-set-rest)',
            warmUp: 'var(--color-warm-up)'
        };
        
        getElem('timer-container').style.borderColor = phaseColors[state.phase] || 'transparent';
        getElem('phase-display').textContent = state.phase;
        getElem('timer-display').textContent = formatTime(state.currentTime);
        
        const currentEx = state.settings.exercises[state.currentSet - 1] || { name: "---", rounds: 0 };
        getElem('exercise-display').textContent = currentEx.name;
        getElem('current-round').textContent = state.currentRound;
        getElem('total-rounds').textContent = currentEx.rounds;
        getElem('current-set').textContent = state.currentSet;
        getElem('total-sets').textContent = state.settings.numSets;
    };

    const formatTime = (s) => `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;

    const startTimer = () => {
        if (state.status === 'running') {
            clearInterval(timerInterval);
            state.status = 'paused';
            getElem('start-pause-btn').textContent = 'Resume';
        } else {
            if (state.status === 'idle') {
                state.phase = state.warmUpEnabled ? 'warmUp' : 'prepare';
                state.currentTime = state.warmUpEnabled ? state.settings.warmUpDuration : 5;
                state.currentSet = 1;
                state.currentRound = 1;
            }
            state.status = 'running';
            getElem('start-pause-btn').textContent = 'Pause';
            timerInterval = setInterval(tick, 1000);
        }
    };

    const tick = () => {
        if (state.currentTime > 0) {
            state.currentTime--;
        } else {
            // Transitions
            const currentEx = state.settings.exercises[state.currentSet - 1];
            if (state.phase === 'warmUp') {
                state.phase = 'prepare'; state.currentTime = 5;
            } else if (state.phase === 'prepare' || state.phase === 'setRest') {
                state.phase = 'work'; state.currentTime = state.settings.workTime;
            } else if (state.phase === 'work') {
                if (state.currentRound < currentEx.rounds) {
                    state.phase = 'rest'; state.currentTime = state.settings.restTime;
                } else if (state.currentSet < state.settings.numSets) {
                    state.phase = 'setRest'; state.currentTime = state.settings.restBetweenSets;
                    state.currentSet++; state.currentRound = 1;
                } else {
                    clearInterval(timerInterval);
                    state.status = 'complete';
                    getElem('timer-display-content').classList.add('hidden');
                    getElem('completion-message').classList.remove('hidden');
                }
            } else if (state.phase === 'rest') {
                state.currentRound++;
                state.phase = 'work'; state.currentTime = state.settings.workTime;
            }
        }
        updateDisplay();
    };

    // --- EVENT LISTENERS ---
    getElem('start-pause-btn').addEventListener('click', startTimer);
    getElem('reset-btn').addEventListener('click', () => {
        clearInterval(timerInterval);
        state.status = 'idle';
        state.phase = 'prepare';
        getElem('timer-display-content').classList.remove('hidden');
        getElem('completion-message').classList.add('hidden');
        getElem('start-pause-btn').textContent = 'Start';
        applySettingsToUI();
    });

    getElem('main-preset-select').addEventListener('change', (e) => handlePresetChange(e.target.value));
    getElem('settings-btn').addEventListener('click', () => getElem('settings-panel').classList.remove('hidden'));
    getElem('close-settings-btn').addEventListener('click', () => getElem('settings-panel').classList.add('hidden'));
    getElem('exercise-settings-btn').addEventListener('click', () => {
        generateExerciseInputs();
        getElem('exercise-settings-panel').classList.remove('hidden');
    });
    getElem('back-to-settings-from-exercises-btn').addEventListener('click', () => getElem('exercise-settings-panel').classList.add('hidden'));
    
    getElem('update-preset-btn').addEventListener('click', () => {
        state.presets[state.lastPreset] = JSON.parse(JSON.stringify(state.settings));
        saveState();
        alert('Preset Updated!');
    });

    getElem('warm-up-toggle').addEventListener('change', (e) => {
        state.warmUpEnabled = e.target.checked;
        saveState();
    });

    loadState();
});
</script>
</body>
</html>
