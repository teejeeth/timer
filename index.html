<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Round Timer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #111827; 
            --bg-secondary: #1f2937; 
            --bg-tertiary: #374151; 
            --bg-accent: #4b5563; 
            --text-primary: #f9fafb; 
            --text-secondary: #d1d5db; 
            --text-accent: #6b7280; 
            --color-warm-up: #f59e0b;
            --color-prepare: #facc15;
            --color-work: #C51E3A;    
            --color-rest: #4ade80;    
            --color-set-rest: #2dd4bf;
            --btn-primary: #3b82f6; 
            --btn-secondary: #ef4444; 
            --btn-start: #22c55e; 
            --btn-save: #f59e0b; 
            --btn-rename: #8b5cf6; 
            --gold-glow: #fbbf24;
        }

        body {
            font-family: 'Inter', sans-serif;
            touch-action: manipulation;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: hidden;
        }
        
        #timer-container {
            transition: background-color 0.5s ease, color 0.3s ease;
            border: 4px solid rgba(255, 255, 255, 0.1); 
        }

        #timer-container.prepare-mode {
            color: #000000 !important;
        }
        .prepare-mode #exercise-display, 
        .prepare-mode #phase-display,
        .prepare-mode #timer-display,
        .prepare-mode label,
        .prepare-mode #main-preset-select,
        .prepare-mode #next-exercise-label {
            color: #000000 !important;
        }
        
        .prepare-mode .custom-select {
            background-image: url('data:image/svg+xml;utf8,<svg fill="black" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');
        }

        .timer-display { font-weight: 900; line-height: 1; }
        .btn { transition: all 0.2s ease; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn:active { transform: scale(0.95); }
        
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        .custom-select {
            -webkit-appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg fill="white" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 0.7rem center;
            background-size: 1.2em;
            padding-right: 2.5rem;
            cursor: pointer;
        }

        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--bg-accent); transition: .4s; border-radius: 28px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--btn-start); }
        input:checked + .slider:before { transform: translateX(22px); }

        #progress-bar-container { width: 100%; height: 12px; background-color: rgba(0, 0, 0, 0.15); border-radius: 6px; overflow: hidden; margin-top: 1rem; }
        #progress-bar { height: 100%; background-color: currentColor; width: 100%; transition: width 1s linear; }
        
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: var(--bg-tertiary); border-radius: 10px; }

        /* Gold Thick Pulsing Border for Next Exercise */
        #next-exercise-container {
            background-color: rgba(0, 0, 0, 0.3);
            border: 4px solid var(--gold-glow);
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.3);
            animation: gold-pulse 1.5s infinite ease-in-out;
            color: var(--text-primary);
        }

        @keyframes gold-pulse {
            0%, 100% { 
                border-color: rgba(251, 191, 36, 0.5);
                box-shadow: 0 0 10px rgba(251, 191, 36, 0.2);
                transform: scale(1);
            }
            50% { 
                border-color: rgba(251, 191, 36, 1);
                box-shadow: 0 0 25px rgba(251, 191, 36, 0.6);
                transform: scale(1.02);
            }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-md mx-auto">
        <div id="timer-container" class="rounded-2xl shadow-2xl p-6 relative" style="background-color: var(--bg-secondary);">
            
            <!-- View 1: Active Timer -->
            <div id="main-timer-view">
                <div id="display-area" class="text-center mb-4 relative h-auto py-8 flex flex-col items-center justify-center rounded-xl">
                    <div id="timer-display-content" class="z-0 w-full px-4">
                        <div id="phase-display" class="text-3xl font-bold uppercase mb-2">Prepare</div>
                        <div id="timer-display" class="text-8xl md:text-9xl timer-display tracking-tight tabular-nums whitespace-nowrap">--:--</div>
                        <div id="progress-bar-container"><div id="progress-bar"></div></div>

                        <div id="progress-display" class="text-xl mt-6 flex items-center justify-center gap-6">
                            <button id="skip-back-btn" class="p-2 rounded-full hover:bg-black hover:bg-opacity-10 btn"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="m15 18-6-6 6-6"/></svg></button>
                            <div class="flex flex-col items-center leading-tight">
                                <span>Round <span id="current-round">0</span>/<span id="total-rounds">0</span></span>
                                <span class="text-xl opacity-80">Set <span id="current-set">0</span>/<span id="total-sets">0</span></span>
                            </div>
                            <button id="skip-forward-btn" class="p-2 rounded-full hover:bg-black hover:bg-opacity-10 btn"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="m9 18 6-6-6-6"/></svg></button>
                        </div>
                    </div>
                    <div id="completion-message" class="hidden text-center py-10">
                        <h2 class="text-4xl font-extrabold mb-4">Workout Done!</h2>
                        <button id="done-reset-btn" class="bg-blue-600 px-8 py-3 rounded-full font-bold btn mx-auto">Restart</button>
                    </div>
                </div>
                
                <div id="exercise-display-container" class="text-center mb-4 p-3 rounded-lg" style="background-color: rgba(0,0,0,0.15);">
                    <h4 class="text-sm font-semibold uppercase opacity-75">Current Exercise</h4>
                    <p id="exercise-display" class="text-2xl font-bold truncate">---</p>
                </div>

                <!-- Next Exercise Preview (Thick Gold Glow) -->
                <div id="next-exercise-container" class="hidden mb-4 p-3 rounded-lg text-center transition-all">
                    <h4 id="next-exercise-label" class="text-xs font-black uppercase opacity-80 tracking-widest">Next Up</h4>
                    <p id="next-exercise-display" class="text-2xl font-bold truncate">---</p>
                </div>
                
                <div id="main-preset-container" class="mb-4">
                    <label class="block text-center font-semibold uppercase text-sm mb-2 opacity-75">Workout Preset</label>
                    <select id="main-preset-select" class="custom-select w-full font-extrabold py-3 px-4 rounded-lg text-lg transition-colors shadow-inner" style="background-color: rgba(0,0,0,0.25); border: 1px solid rgba(255,255,255,0.1); color: inherit;"></select>
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <button id="start-pause-btn" class="font-bold py-3 rounded-lg text-lg btn text-white shadow-lg" style="background-color: var(--btn-start);">Start</button>
                    <button id="reset-btn" class="font-bold py-3 rounded-lg text-lg btn text-white shadow-lg" style="background-color: var(--btn-secondary);">Reset</button>
                    <button id="settings-btn" class="font-bold py-3 rounded-lg text-lg btn text-white shadow-lg" style="background-color: var(--btn-primary);">Settings</button>
                </div>
            </div>

            <!-- View 2: Settings Panel -->
            <div id="settings-panel" class="hidden">
                <h3 class="text-2xl font-bold mb-6 text-center">Settings</h3>
                <div id="timer-inputs-container" class="grid grid-cols-2 gap-4 mb-6"></div>
                
                <div class="mb-4 p-4 rounded-lg space-y-3" style="background-color: var(--bg-tertiary);">
                    <div class="flex items-center justify-between">
                        <span class="font-bold">Warm up</span>
                        <label class="toggle-switch"><input type="checkbox" id="warm-up-toggle"><span class="slider"></span></label>
                    </div>
                    <div id="warm-up-duration-container" class="hidden">
                        <label class="block text-xs font-bold opacity-70 mb-1">Warm up Duration (s)</label>
                        <input type="number" id="warm-up-duration-input" class="w-full bg-gray-900 p-2 rounded border border-gray-700">
                    </div>
                </div>

                <div class="mb-4">
                    <select id="preset-select" class="custom-select w-full font-bold py-3 px-4 rounded-lg" style="background-color: var(--bg-tertiary); border: 1px solid rgba(255,255,255,0.1);"></select>
                </div>

                <div class="grid grid-cols-3 gap-2 mb-4">
                    <button id="update-preset-btn" class="py-2 rounded-lg btn text-sm text-white" style="background-color: var(--btn-save);">Save</button>
                    <button id="manage-presets-btn" class="py-2 rounded-lg btn text-sm text-white" style="background-color: var(--btn-rename);">Manage</button>
                    <button id="exercise-settings-btn" class="py-2 rounded-lg btn text-sm text-white" style="background-color: var(--bg-accent);">Exercises</button>
                </div>
                <button id="close-settings-btn" class="w-full py-3 rounded-lg btn text-white" style="background-color: var(--btn-start);">Done</button>
            </div>

            <!-- View 3: Manage Presets -->
            <div id="manage-presets-content" class="hidden">
                <h3 class="text-2xl font-bold mb-4 text-center">Manage Presets</h3>
                
                <div class="mb-4 flex gap-2">
                    <input type="text" id="new-preset-name" placeholder="New preset name..." class="flex-1 bg-gray-900 p-2 rounded border border-gray-700">
                    <button id="add-preset-btn" class="px-4 rounded-lg btn font-bold text-white" style="background-color: var(--btn-start);">Add</button>
                </div>

                <div id="preset-management-list" class="space-y-2 max-h-64 overflow-y-auto custom-scroll mb-6 pr-2"></div>
                <button id="back-to-settings-btn" class="w-full py-3 rounded-lg btn text-white" style="background-color: var(--btn-primary);">Back</button>
            </div>

            <!-- View 4: Exercise Configuration -->
            <div id="exercise-settings-panel" class="hidden">
                <h3 class="text-xl font-bold mb-4 text-center">Configure Exercises</h3>
                <div id="exercise-inputs-container" class="space-y-4 max-h-80 overflow-y-auto custom-scroll mb-4 pr-2"></div>
                
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <button id="add-exercise-btn" class="py-3 rounded-lg btn text-white font-bold bg-green-600 shadow-lg">Add New</button>
                    <button id="back-to-settings-from-ex-btn" class="py-3 rounded-lg btn text-white font-bold bg-blue-600 shadow-lg">Back</button>
                </div>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const getElem = (id) => document.getElementById(id);
    const createExercise = (name, rounds) => ({ name: name || "New Exercise", rounds: rounds || 1 });

    const defaultPresets = {
        "Day start": { workTime: 35, restTime: 0, restBetweenSets: 0, warmUpDuration: 0, exercises: [createExercise("Jumping shoulder drops", 1), createExercise("Arm raises", 1), createExercise("Hindu squats", 1), createExercise("Hof stance", 1)] },
        "Athletic": { workTime: 35, restTime: 25, restBetweenSets: 75, warmUpDuration: 300, exercises: [createExercise("Kettlebell OHP", 6), createExercise("Kettlebell row", 6), createExercise("Woodchoppers", 6), createExercise("SL squat", 4), createExercise("SL Deadlift", 6), createExercise("Kettlebell swing", 4)] },
        "Sturdy": { workTime: 35, restTime: 25, restBetweenSets: 75, warmUpDuration: 300, exercises: [createExercise("Dumbell rows", 4), createExercise("Dumbell OHP", 4), createExercise("Kettlebell squat", 3), createExercise("Kettlebell lateral squat", 6), createExercise("Split squat", 6), createExercise("Kettlebell windmill", 3), createExercise("Hip flexors", 4)] },
        "Thasmin": { workTime: 35, restTime: 25, restBetweenSets: 75, warmUpDuration: 300, exercises: [createExercise("Kettlebell power cleans", 3), createExercise("Kettlebell swings", 3), createExercise("Split squat", 3), createExercise("Squat", 3), createExercise("Hip thrust", 3), createExercise("Monster walk", 3), createExercise("Resistance band row", 3)] },
        "Access": { workTime: 35, restTime: 25, restBetweenSets: 75, warmUpDuration: 300, exercises: [createExercise("Glute medius plate", 1), createExercise("Kettlebell halos", 1), createExercise("Power twister", 1), createExercise("Forearms", 1), createExercise("Neck", 1), createExercise("Abs", 1), createExercise("Running man + hammer curls", 1)] }
    };

    let state = {
        status: 'idle', phase: 'prepare', currentTime: 0, currentRound: 0, currentSet: 0,
        warmUpEnabled: false, lastPreset: "Day start",
        presets: JSON.parse(JSON.stringify(defaultPresets)),
        settings: JSON.parse(JSON.stringify(defaultPresets["Day start"]))
    };

    let timerInterval = null;

    const saveState = () => localStorage.setItem('workoutTimer_v13', JSON.stringify({ presets: state.presets, settings: state.settings, warmUpEnabled: state.warmUpEnabled, lastPreset: state.lastPreset }));

    const stopTimer = () => { if(timerInterval) clearInterval(timerInterval); timerInterval = null; };

    const resetState = () => {
        stopTimer();
        state.status = 'idle';
        state.phase = 'prepare';
        state.currentTime = 0;
        state.currentRound = 0;
        state.currentSet = 0;
        getElem('timer-display-content').classList.remove('hidden');
        getElem('completion-message').classList.add('hidden');
        getElem('start-pause-btn').textContent = 'Start';
        updateDisplay();
    };

    const loadState = () => {
        const saved = localStorage.getItem('workoutTimer_v13');
        if (saved) {
            const parsed = JSON.parse(saved);
            state.presets = parsed.presets;
            state.settings = JSON.parse(JSON.stringify(parsed.settings));
            state.warmUpEnabled = parsed.warmUpEnabled;
            state.lastPreset = parsed.lastPreset;
        }
        syncUI();
    };

    const syncUI = () => {
        getElem('warm-up-toggle').checked = state.warmUpEnabled;
        getElem('warm-up-duration-input').value = state.settings.warmUpDuration;
        getElem('warm-up-duration-container').classList.toggle('hidden', !state.warmUpEnabled);

        const selects = [getElem('main-preset-select'), getElem('preset-select')];
        selects.forEach(sel => {
            sel.innerHTML = '';
            Object.keys(state.presets).forEach(name => {
                const opt = document.createElement('option');
                opt.value = name; opt.textContent = name;
                sel.appendChild(opt);
            });
            sel.value = state.lastPreset;
        });
        generateSettingsInputs();
        updateDisplay();
    };

    const generateSettingsInputs = () => {
        const container = getElem('timer-inputs-container');
        container.innerHTML = '';
        const fields = [{id:'workTime', l:'Work (s)'}, {id:'restTime', l:'Rest (s)'}, {id:'restBetweenSets', l:'Set Rest (s)'}];
        fields.forEach(f => {
            const div = document.createElement('div');
            div.innerHTML = `<label class="block text-xs font-bold opacity-70">${f.l}</label><input type="number" value="${state.settings[f.id]}" class="w-full bg-gray-900 p-2 rounded border border-gray-700 mt-1">`;
            div.querySelector('input').oninput = (e) => { state.settings[f.id] = parseInt(e.target.value) || 0; saveState(); };
            container.appendChild(div);
        });
        const setDiv = document.createElement('div');
        setDiv.innerHTML = `<label class="block text-xs font-bold opacity-70">Exercise Count</label><div class="w-full bg-gray-800 p-2 rounded border border-gray-700 mt-1 opacity-50 font-bold">${state.settings.exercises.length}</div>`;
        container.appendChild(setDiv);
    };

    const updateDisplay = () => {
        const container = getElem('timer-container');
        const colors = { prepare: 'var(--color-prepare)', work: 'var(--color-work)', rest: 'var(--color-rest)', setRest: 'var(--color-set-rest)', warmUp: 'var(--color-warm-up)', idle: 'var(--bg-secondary)' };
        
        const phaseColor = state.status === 'idle' ? colors.idle : colors[state.phase];
        container.style.backgroundColor = phaseColor;

        if (state.phase === 'prepare' && state.status !== 'idle') container.classList.add('prepare-mode');
        else container.classList.remove('prepare-mode');

        let displayPhase = state.phase;
        if (displayPhase === 'setRest') displayPhase = 'Set Rest';
        
        getElem('phase-display').textContent = state.status === 'idle' ? 'Ready' : displayPhase;
        getElem('timer-display').textContent = `${Math.floor(state.currentTime/60).toString().padStart(2,'0')}:${(state.currentTime%60).toString().padStart(2,'0')}`;
        
        const currentExIdx = Math.max(0, state.currentSet - 1);
        const currentEx = state.settings.exercises[currentExIdx] || { name: "---", rounds: 0 };
        getElem('exercise-display').textContent = currentEx.name;
        getElem('current-round').textContent = state.currentRound || 0;
        getElem('total-rounds').textContent = currentEx.rounds || 0;
        getElem('current-set').textContent = state.currentSet || 0;
        getElem('total-sets').textContent = state.settings.exercises.length;

        // Hide Preset Selector while running/paused
        const presetContainer = getElem('main-preset-container');
        if (state.status !== 'idle') {
            presetContainer.classList.add('hidden');
        } else {
            presetContainer.classList.remove('hidden');
        }

        // Next Exercise Preview logic
        const nextExContainer = getElem('next-exercise-container');
        const showNext = (state.phase === 'rest' || state.phase === 'setRest') && state.status === 'running';
        
        if (showNext) {
            let nextExName = "";
            if (state.phase === 'setRest') {
                nextExName = state.settings.exercises[state.currentSet]?.name || "";
            } else if (state.phase === 'rest') {
                if (state.currentRound < currentEx.rounds) {
                    nextExName = currentEx.name;
                } else {
                    nextExName = state.settings.exercises[state.currentSet]?.name || "";
                }
            }

            if (nextExName) {
                getElem('next-exercise-display').textContent = nextExName;
                nextExContainer.classList.remove('hidden');
                // Set font color to same as current exercise (which is text-primary in non-prepare modes)
                const isPrepare = state.phase === 'prepare' && state.status !== 'idle';
                getElem('next-exercise-display').style.color = isPrepare ? '#000000' : 'var(--text-primary)';
            } else {
                nextExContainer.classList.add('hidden');
            }
        } else {
            nextExContainer.classList.add('hidden');
        }

        let totalTimeForPhase = 1;
        if (state.phase === 'work') totalTimeForPhase = state.settings.workTime;
        else if (state.phase === 'rest') totalTimeForPhase = state.settings.restTime;
        else if (state.phase === 'setRest') totalTimeForPhase = state.settings.restBetweenSets;
        else if (state.phase === 'warmUp') totalTimeForPhase = state.settings.warmUpDuration;
        else if (state.phase === 'prepare') totalTimeForPhase = 5;

        const progressPercent = (state.currentTime / (totalTimeForPhase || 1)) * 100;
        getElem('progress-bar').style.width = `${progressPercent}%`;
    };

    const setPhaseTime = (phase) => {
        if (phase === 'warmUp') return state.settings.warmUpDuration;
        if (phase === 'prepare') return 5;
        if (phase === 'work') return state.settings.workTime;
        if (phase === 'rest') return state.settings.restTime;
        if (phase === 'setRest') return state.settings.restBetweenSets;
        return 0;
    };

    const nextPhase = () => {
        const currentEx = state.settings.exercises[state.currentSet - 1];
        
        if (state.phase === 'warmUp') { 
            state.phase = 'prepare'; 
            state.currentTime = setPhaseTime('prepare'); 
        } else if (state.phase === 'prepare') { 
            state.phase = 'work'; 
            state.currentTime = setPhaseTime('work'); 
        } else if (state.phase === 'rest') {
            state.currentRound++;
            state.phase = 'work';
            state.currentTime = setPhaseTime('work');
        } else if (state.phase === 'setRest') {
            state.currentSet++;
            state.currentRound = 1;
            state.phase = 'work';
            state.currentTime = setPhaseTime('work');
        } else if (state.phase === 'work') {
            if (state.currentRound < currentEx.rounds) {
                const restTime = setPhaseTime('rest');
                if (restTime > 0) {
                    state.phase = 'rest'; 
                    state.currentTime = restTime;
                } else {
                    state.currentRound++;
                    state.phase = 'work';
                    state.currentTime = setPhaseTime('work');
                }
            } else if (state.currentSet < state.settings.exercises.length) {
                const setRestTime = setPhaseTime('setRest');
                if (setRestTime > 0) {
                    state.phase = 'setRest'; 
                    state.currentTime = setRestTime;
                } else {
                    state.currentSet++;
                    state.currentRound = 1;
                    state.phase = 'work';
                    state.currentTime = setPhaseTime('work');
                }
            } else { 
                stopTimer(); state.status = 'complete'; 
                getElem('timer-display-content').classList.add('hidden'); 
                getElem('completion-message').classList.remove('hidden'); 
            }
        }
        updateDisplay();
    };

    const tick = () => {
        if (state.currentTime > 0) { 
            state.currentTime--; 
            updateDisplay(); 
        } else { 
            nextPhase(); 
        }
    };

    getElem('start-pause-btn').onclick = () => {
        if (state.status === 'running') { 
            stopTimer(); state.status = 'paused'; 
            getElem('start-pause-btn').textContent = 'Resume'; 
            updateDisplay();
        } else {
            if (state.status === 'idle') { 
                state.phase = state.warmUpEnabled ? 'warmUp' : 'prepare'; 
                state.currentTime = setPhaseTime(state.phase);
                state.currentSet = 1; state.currentRound = 1; 
            }
            state.status = 'running'; getElem('start-pause-btn').textContent = 'Pause';
            timerInterval = setInterval(tick, 1000);
            updateDisplay();
        }
    };

    getElem('reset-btn').onclick = resetState;
    getElem('done-reset-btn').onclick = resetState;

    const handlePresetChange = (presetName) => {
        resetState();
        state.lastPreset = presetName;
        state.settings = JSON.parse(JSON.stringify(state.presets[presetName]));
        syncUI();
        saveState();
    };

    getElem('main-preset-select').onchange = (e) => handlePresetChange(e.target.value);
    getElem('preset-select').onchange = (e) => handlePresetChange(e.target.value);

    getElem('skip-forward-btn').onclick = () => {
        if (state.status === 'idle') return;
        const currentEx = state.settings.exercises[state.currentSet - 1];
        if (state.currentRound < currentEx.rounds) {
            state.currentRound++; state.phase = 'work'; state.currentTime = setPhaseTime('work');
        } else if (state.currentSet < state.settings.exercises.length) {
            state.currentSet++; state.currentRound = 1; state.phase = 'work'; state.currentTime = setPhaseTime('work');
        } else {
            stopTimer(); state.status = 'complete';
            getElem('timer-display-content').classList.add('hidden');
            getElem('completion-message').classList.remove('hidden');
        }
        updateDisplay();
    };

    getElem('skip-back-btn').onclick = () => {
        if (state.status === 'idle') return;
        if (state.currentRound > 1) {
            state.currentRound--; state.phase = 'work'; state.currentTime = setPhaseTime('work');
        } else if (state.currentSet > 1) {
            state.currentSet--;
            state.currentRound = state.settings.exercises[state.currentSet - 1].rounds;
            state.phase = 'work'; state.currentTime = setPhaseTime('work');
        } else {
            state.phase = state.warmUpEnabled ? 'warmUp' : 'prepare';
            state.currentTime = setPhaseTime(state.phase);
            state.currentRound = 1; state.currentSet = 1;
        }
        updateDisplay();
    };

    const renderExercises = () => {
        const container = getElem('exercise-inputs-container');
        container.innerHTML = '';
        state.settings.exercises.forEach((ex, i) => {
            const div = document.createElement('div');
            div.className = "bg-gray-800 p-3 rounded-lg border border-gray-700 space-y-3 relative";
            div.innerHTML = `
                <div class="flex items-center gap-2">
                    <span class="text-xs font-bold bg-gray-900 w-6 h-6 flex items-center justify-center rounded-full">${i+1}</span>
                    <input type="text" value="${ex.name}" class="flex-1 bg-transparent border-b border-gray-600 focus:border-blue-500 outline-none text-sm py-1">
                    <button class="delete-btn text-red-500 p-1"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-xs font-bold opacity-60">ROUNDS</span>
                    <div class="flex items-center gap-1">
                        <button class="minus-btn w-8 h-8 bg-gray-700 rounded btn">-</button>
                        <input type="number" value="${ex.rounds}" class="rounds-input w-10 bg-gray-900 text-center font-bold">
                        <button class="plus-btn w-8 h-8 bg-gray-700 rounded btn">+</button>
                    </div>
                </div>
            `;
            div.querySelector('input[type="text"]').oninput = (e) => { state.settings.exercises[i].name = e.target.value; saveState(); };
            div.querySelector('.delete-btn').onclick = () => {
                if(state.settings.exercises.length > 1) {
                    state.settings.exercises.splice(i, 1);
                    saveState(); renderExercises();
                }
            };
            const updateR = (v) => { 
                state.settings.exercises[i].rounds = Math.max(1, parseInt(v) || 1); 
                div.querySelector('.rounds-input').value = state.settings.exercises[i].rounds;
                saveState(); 
            };
            div.querySelector('.minus-btn').onclick = () => updateR(state.settings.exercises[i].rounds - 1);
            div.querySelector('.plus-btn').onclick = () => updateR(state.settings.exercises[i].rounds + 1);
            div.querySelector('.rounds-input').oninput = (e) => updateR(e.target.value);
            container.appendChild(div);
        });
    };

    getElem('add-exercise-btn').onclick = () => {
        state.settings.exercises.push(createExercise());
        saveState(); renderExercises();
    };

    getElem('settings-btn').onclick = () => { ['main-timer-view', 'settings-panel', 'manage-presets-content', 'exercise-settings-panel'].forEach(p => getElem(p).classList.add('hidden')); getElem('settings-panel').classList.remove('hidden'); };
    getElem('close-settings-btn').onclick = () => { ['main-timer-view', 'settings-panel', 'manage-presets-content', 'exercise-settings-panel'].forEach(p => getElem(p).classList.add('hidden')); getElem('main-timer-view').classList.remove('hidden'); syncUI(); };
    getElem('exercise-settings-btn').onclick = () => { renderExercises(); ['main-timer-view', 'settings-panel', 'manage-presets-content', 'exercise-settings-panel'].forEach(p => getElem(p).classList.add('hidden')); getElem('exercise-settings-panel').classList.remove('hidden'); };
    getElem('back-to-settings-from-ex-btn').onclick = () => { ['main-timer-view', 'settings-panel', 'manage-presets-content', 'exercise-settings-panel'].forEach(p => getElem(p).classList.add('hidden')); getElem('settings-panel').classList.remove('hidden'); syncUI(); };
    getElem('manage-presets-btn').onclick = () => {
        const list = getElem('preset-management-list');
        list.innerHTML = '';
        Object.keys(state.presets).forEach(name => {
            const div = document.createElement('div');
            div.className = "flex items-center justify-between bg-gray-700 p-2 rounded mb-2";
            div.innerHTML = `<span class="font-bold">${name}</span><button class="bg-red-600 px-3 py-1 rounded text-xs btn">Delete</button>`;
            div.querySelector('button').onclick = () => {
                if (Object.keys(state.presets).length > 1) { delete state.presets[name]; if (state.lastPreset === name) handlePresetChange(Object.keys(state.presets)[0]); else syncUI(); saveState(); getElem('manage-presets-btn').click(); }
            };
            list.appendChild(div);
        });
        ['main-timer-view', 'settings-panel', 'manage-presets-content', 'exercise-settings-panel'].forEach(p => getElem(p).classList.add('hidden')); getElem('manage-presets-content').classList.remove('hidden');
    };
    getElem('back-to-settings-btn').onclick = () => { ['main-timer-view', 'settings-panel', 'manage-presets-content', 'exercise-settings-panel'].forEach(p => getElem(p).classList.add('hidden')); getElem('settings-panel').classList.remove('hidden'); };

    getElem('add-preset-btn').onclick = () => {
        const nameInput = getElem('new-preset-name');
        const name = nameInput.value.trim();
        if (name && !state.presets[name]) {
            state.presets[name] = JSON.parse(JSON.stringify(state.settings));
            state.lastPreset = name;
            nameInput.value = '';
            saveState(); syncUI(); getElem('manage-presets-btn').click();
        }
    };

    getElem('update-preset-btn').onclick = () => {
        state.presets[state.lastPreset] = JSON.parse(JSON.stringify(state.settings));
        saveState(); 
        const btn = getElem('update-preset-btn'); btn.textContent = "Saved!";
        setTimeout(() => btn.textContent = "Save", 1000);
    };

    getElem('warm-up-toggle').onchange = (e) => { state.warmUpEnabled = e.target.checked; getElem('warm-up-duration-container').classList.toggle('hidden', !state.warmUpEnabled); saveState(); };
    getElem('warm-up-duration-input').oninput = (e) => { state.settings.warmUpDuration = parseInt(e.target.value) || 0; saveState(); };

    loadState();
});
</script>
</body>
</html>
