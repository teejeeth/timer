<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>beep boop timer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #111827; /* gray-900 */
            --bg-secondary: #1f2937; /* gray-800 */
            --bg-tertiary: #374151; /* gray-700 */
            --bg-accent: #4b5563; /* gray-600 */
            --text-primary: #f9fafb; /* gray-50 */
            --text-secondary: #d1d5db; /* gray-300 */
            --text-accent: #6b7280; /* gray-500 */
            --color-prepare: #facc15; /* yellow-400 */
            --color-work: #4ade80; /* green-400 */
            --color-rest: #a78bfa; /* violet-400 */
            --color-set-rest: #60a5fa; /* blue-400 */
            --btn-primary: #3b82f6; /* blue-500 */
            --btn-primary-hover: #2563eb; /* blue-600 */
            --btn-secondary: #ef4444; /* red-500 */
            --btn-secondary-hover: #dc2626; /* red-600 */
            --btn-start: #22c55e; /* green-500 */
            --btn-start-hover: #16a34a; /* green-600 */
            --btn-preset: #14b8a6; /* teal-500 */
            --btn-preset-hover: #0d9488; /* teal-600 */
            --btn-save: #f59e0b; /* amber-500 */
            --btn-save-hover: #d97706; /* amber-600 */
        }
        .theme-forest {
            --bg-primary: #1a2e29; --bg-secondary: #2d4a43; --bg-tertiary: #3e6058; --bg-accent: #507a6d;
            --text-primary: #e8f5e9; --text-secondary: #a5d6a7; --text-accent: #81c784;
            --color-prepare: #ffb74d; --color-work: #aed581; --color-rest: #90a4ae; --color-set-rest: #7986cb;
            --btn-primary: #4db6ac; --btn-primary-hover: #26a69a; --btn-secondary: #e57373; --btn-secondary-hover: #ef5350;
            --btn-start: #81c784; --btn-start-hover: #66bb6a; --btn-preset: #66bb6a; --btn-preset-hover: #4caf50;
        }
        .theme-ocean {
            --bg-primary: #0d1b2a; --bg-secondary: #1b263b; --bg-tertiary: #415a77; --bg-accent: #778da9;
            --text-primary: #e0e1dd; --text-secondary: #b0c4de; --text-accent: #a9b4c2;
            --color-prepare: #ffcc80; --color-work: #64ffda; --color-rest: #82a0ff; --color-set-rest: #40c4ff;
            --btn-primary: #40c4ff; --btn-primary-hover: #00b0ff; --btn-secondary: #ff8a80; --btn-secondary-hover: #ff5252;
            --btn-start: #69f0ae; --btn-start-hover: #00e676; --btn-preset: #80d8ff; --btn-preset-hover: #40c4ff;
        }
        .theme-sunset {
            --bg-primary: #2c132a; --bg-secondary: #4a2545; --bg-tertiary: #6d3b5d; --bg-accent: #9d5c63;
            --text-primary: #fceceb; --text-secondary: #f4acb7; --text-accent: #e57373;
            --color-prepare: #ffd54f; --color-work: #ff8a65; --color-rest: #ba68c8; --color-set-rest: #7986cb;
            --btn-primary: #f06292; --btn-primary-hover: #ec407a; --btn-secondary: #e57373; --btn-secondary-hover: #ef5350;
            --btn-start: #ffb74d; --btn-start-hover: #ffa726; --btn-preset: #ff8a65; --btn-preset-hover: #ff7043;
        }
        .theme-spring {
            --bg-primary: #f0fff4; --bg-secondary: #d4edda; --bg-tertiary: #b8e0c2; --bg-accent: #9cd3ab;
            --text-primary: #0c3b2e; --text-secondary: #1e4620; --text-accent: #3e624d;
            --color-prepare: #ffc107; --color-work: #ff6b6b; --color-rest: #4dabf7; --color-set-rest: #9c88ff;
            --btn-primary: #4dabf7; --btn-primary-hover: #3b9bff; --btn-secondary: #ff6b6b; --btn-secondary-hover: #ff4d4d;
            --btn-start: #4caf50; --btn-start-hover: #45a049; --btn-preset: #ffa726; --btn-preset-hover: #fb8c00;
        }
        .theme-summer {
            --bg-primary: #fff3e0; --bg-secondary: #ffe0b2; --bg-tertiary: #ffcc80; --bg-accent: #ffb74d;
            --text-primary: #3e2723; --text-secondary: #5d4037; --text-accent: #795548;
            --color-prepare: #2196f3; --color-work: #f44336; --color-rest: #4caf50; --color-set-rest: #ff9800;
            --btn-primary: #2196f3; --btn-primary-hover: #1e88e5; --btn-secondary: #f44336; --btn-secondary-hover: #e53935;
            --btn-start: #ffeb3b; --btn-start-hover: #fdd835; --btn-preset: #ff9800; --btn-preset-hover: #fb8c00;
        }
        .theme-winter {
            --bg-primary: #e3f2fd; --bg-secondary: #bbdefb; --bg-tertiary: #90caf9; --bg-accent: #64b5f6;
            --text-primary: #0d47a1; --text-secondary: #1565c0; --text-accent: #1976d2;
            --color-prepare: #fbc02d; --color-work: #d32f2f; --color-rest: #7b1fa2; --color-set-rest: #00796b;
            --btn-primary: #1976d2; --btn-primary-hover: #1565c0; --btn-secondary: #d32f2f; --btn-secondary-hover: #c62828;
            --btn-start: #388e3c; --btn-start-hover: #2e7d32; --btn-preset: #512da8; --btn-preset-hover: #4527a0;
        }
        .theme-desert {
            --bg-primary: #fdf6e3; --bg-secondary: #f5e5c0; --bg-tertiary: #e6d5a8; --bg-accent: #d7c590;
            --text-primary: #654f34; --text-secondary: #8c6f4e; --text-accent: #a38a6a;
            --color-prepare: #268bd2; --color-work: #dc322f; --color-rest: #859900; --color-set-rest: #cb4b16;
            --btn-primary: #268bd2; --btn-primary-hover: #2075b2; --btn-secondary: #dc322f; --btn-secondary-hover: #c02b28;
            --btn-start: #859900; --btn-start-hover: #738300; --btn-preset: #cb4b16; --btn-preset-hover: #b34213;
        }
        .theme-jungle {
            --bg-primary: #004d40; --bg-secondary: #00695c; --bg-tertiary: #00796b; --bg-accent: #00897b;
            --text-primary: #e0f2f1; --text-secondary: #b2dfdb; --text-accent: #80cbc4;
            --color-prepare: #ffab00; --color-work: #ff3d00; --color-rest: #d500f9; --color-set-rest: #2979ff;
            --btn-primary: #00bfa5; --btn-primary-hover: #00a28e; --btn-secondary: #f50057; --btn-secondary-hover: #c51162;
            --btn-start: #76ff03; --btn-start-hover: #64dd17; --btn-preset: #ffc400; --btn-preset-hover: #ffab00;
        }
        .theme-mountain {
            --bg-primary: #455a64; --bg-secondary: #546e7a; --bg-tertiary: #607d8b; --bg-accent: #78909c;
            --text-primary: #eceff1; --text-secondary: #cfd8dc; --text-accent: #b0bec5;
            --color-prepare: #fdd835; --color-work: #fb8c00; --color-rest: #42a5f5; --color-set-rest: #ab47bc;
            --btn-primary: #42a5f5; --btn-primary-hover: #1e88e5; --btn-secondary: #ef5350; --btn-secondary-hover: #e53935;
            --btn-start: #66bb6a; --btn-start-hover: #4caf50; --btn-preset: #7e57c2; --btn-preset-hover: #673ab7;
        }
        .theme-coast {
            --bg-primary: #fffde7; --bg-secondary: #fff9c4; --bg-tertiary: #fff59d; --bg-accent: #fff176;
            --text-primary: #3e2723; --text-secondary: #5d4037; --text-accent: #795548;
            --color-prepare: #03a9f4; --color-work: #ff5722; --color-rest: #009688; --color-set-rest: #8bc34a;
            --btn-primary: #03a9f4; --btn-primary-hover: #0288d1; --btn-secondary: #ff5722; --btn-secondary-hover: #f4511e;
            --btn-start: #8bc34a; --btn-start-hover: #7cb342; --btn-preset: #00bcd4; --btn-preset-hover: #00acc1;
        }
        .theme-sakura {
            --bg-primary: #fff0f5; --bg-secondary: #ffe4e1; --bg-tertiary: #ffc0cb; --bg-accent: #ffb6c1;
            --text-primary: #8b0000; --text-secondary: #a52a2a; --text-accent: #bc8f8f;
            --color-prepare: #ffd700; --color-work: #ff1493; --color-rest: #48d1cc; --color-set-rest: #9370db;
            --btn-primary: #ff69b4; --btn-primary-hover: #ff1493; --btn-secondary: #db7093; --btn-secondary-hover: #c71585;
            --btn-start: #32cd32; --btn-start-hover: #228b22; --btn-preset: #dda0dd; --btn-preset-hover: #da70d6;
        }
        body {
            font-family: 'Inter', sans-serif;
            touch-action: manipulation;
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }
        .timer-display { font-weight: 900; line-height: 1; }
        .btn { transition: all 0.2s ease; }
        .btn:active { transform: scale(0.95); }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }
        .panel { transition: opacity 0.3s ease, transform 0.3s ease; }
        .panel.hidden { opacity: 0; transform: scale(0.98); pointer-events: none; display: none; }
        .preset-btn.saving { background-color: var(--btn-save) !important; }
        .preset-btn.saving:hover { background-color: var(--btn-save-hover) !important; }
        /* Toggle Switch Styles */
        .toggle-label {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            padding: 0.75rem;
            border-radius: 0.5rem;
            background-color: var(--bg-tertiary);
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-accent);
            transition: .4s;
            border-radius: 28px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--btn-start);
        }
        input:checked + .slider:before {
            transform: translateX(22px);
        }

    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-md mx-auto">
        <!-- Main Timer View -->
        <div id="timer-container" class="rounded-2xl shadow-2xl p-6 relative panel" style="background-color: var(--bg-secondary);">
            <div id="display-area" class="text-center mb-4 relative h-64 flex flex-col items-center justify-center rounded-xl" style="background-color: var(--bg-primary);">
                <div id="timer-display-content" class="z-0">
                    <div id="phase-display" class="text-2xl font-bold uppercase mb-2" style="color: var(--color-prepare);">Prepare</div>
                    <div id="timer-display" class="text-8xl md:text-9xl timer-display" style="color: var(--color-work);">--:--</div>
                    <div id="progress-display" class="text-xl mt-2" style="color: var(--text-secondary);">
                        Round <span id="current-round">0</span>/<span id="total-rounds">10</span> |
                        Set <span id="current-set">0</span>/<span id="total-sets">5</span>
                    </div>
                </div>
                <div id="completion-message" class="z-10 hidden">
                    <h2 class="text-4xl md:text-5xl font-extrabold" style="color: var(--color-work);">Workout Completed!</h2>
                </div>
            </div>
            
            <div id="exercise-display-container" class="text-center mb-4 p-3 rounded-lg" style="background-color: var(--bg-tertiary);">
                <h4 class="text-sm font-semibold uppercase" style="color: var(--text-secondary);">Current Exercise</h4>
                <p id="exercise-display" class="text-xl font-bold truncate" style="color: var(--text-primary);">---</p>
            </div>

            <div id="controls-container" class="grid grid-cols-3 gap-4">
                <button id="start-pause-btn" class="text-white font-bold py-3 px-4 rounded-lg text-lg btn" style="background-color: var(--btn-start);">Start</button>
                <button id="reset-btn" class="text-white font-bold py-3 px-4 rounded-lg text-lg btn" style="background-color: var(--btn-secondary);">Reset</button>
                <button id="settings-btn" class="text-white font-bold py-3 px-4 rounded-lg text-lg btn" style="background-color: var(--btn-primary);">Settings</button>
            </div>
        </div>

        <!-- Settings Panel -->
        <div id="settings-panel" class="rounded-2xl shadow-2xl p-6 hidden panel" style="background-color: var(--bg-secondary);">
            <h3 class="text-2xl font-bold mb-6 text-center">Settings</h3>
            
            <div id="timer-inputs-container" class="grid grid-cols-2 gap-x-6 gap-y-4 mb-6"></div>

            <div id="settings-toggles-container" class="space-y-4 mb-6"></div>

            <div class="p-4 rounded-lg text-center grid grid-cols-2 gap-4 mb-6" style="background-color: var(--bg-tertiary);">
                <div>
                    <h4 class="text-sm font-semibold uppercase" style="color: var(--text-secondary);">Set Duration</h4>
                    <p id="set-duration-display" class="text-2xl font-bold">00:00</p>
                </div>
                <div>
                    <h4 class="text-sm font-semibold uppercase" style="color: var(--text-secondary);">Total Workout</h4>
                    <p id="total-duration-display" class="text-2xl font-bold">00:00</p>
                </div>
            </div>

            <div class="mb-4">
                <h4 id="preset-heading" class="text-center font-semibold uppercase text-sm mb-2" style="color: var(--text-secondary);">Presets</h4>
                <div id="preset-buttons-container" class="grid grid-cols-3 gap-2"></div>
            </div>
            
            <button id="save-preset-mode-btn" class="w-full text-white font-bold py-2 px-3 rounded-lg text-base btn mb-4" style="background-color: var(--btn-save);">Save as Preset</button>
            
            <div class="grid grid-cols-3 gap-2">
                <button id="themes-settings-btn" class="w-full text-white font-bold py-3 px-4 rounded-lg text-lg btn" style="background-color: var(--bg-accent);">Themes</button>
                <button id="exercise-settings-btn" class="w-full text-white font-bold py-3 px-4 rounded-lg text-lg btn" style="background-color: var(--bg-accent);">Exercises</button>
                <button id="close-settings-btn" class="w-full text-white font-bold py-3 px-4 rounded-lg text-lg btn" style="background-color: var(--btn-primary);">Done</button>
            </div>
        </div>

        <!-- Themes Panel -->
        <div id="themes-panel" class="rounded-2xl shadow-2xl p-6 hidden panel" style="background-color: var(--bg-secondary);">
            <h3 class="text-2xl font-bold mb-6 text-center">Select a Theme</h3>
            <div id="theme-buttons-container" class="grid grid-cols-2 gap-4"></div>
            <button id="back-to-settings-from-themes-btn" class="mt-6 w-full text-white font-bold py-3 px-4 rounded-lg text-lg btn" style="background-color: var(--btn-primary);">Back</button>
        </div>
        
        <!-- Exercise Settings Panel -->
        <div id="exercise-settings-panel" class="rounded-2xl shadow-2xl p-6 hidden panel" style="background-color: var(--bg-secondary);">
            <h3 class="text-2xl font-bold mb-6 text-center">Exercise List</h3>
            <div id="exercise-inputs-container" class="space-y-4 max-h-96 overflow-y-auto pr-2"></div>
            <button id="back-to-settings-from-exercises-btn" class="mt-6 w-full text-white font-bold py-3 px-4 rounded-lg text-lg btn" style="background-color: var(--btn-primary);">Back</button>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- DOM ELEMENT REFERENCES ---
    const getElem = (id) => document.getElementById(id);
    const elements = {
        timerContainer: getElem('timer-container'),
        settingsPanel: getElem('settings-panel'),
        themesPanel: getElem('themes-panel'),
        exerciseSettingsPanel: getElem('exercise-settings-panel'),
        timerDisplayContent: getElem('timer-display-content'),
        completionMessage: getElem('completion-message'),
        currentRoundDisplay: getElem('current-round'),
        totalRoundsDisplay: getElem('total-rounds'),
        currentSetDisplay: getElem('current-set'),
        totalSetsDisplay: getElem('total-sets'),
        exerciseDisplay: getElem('exercise-display'),
        timerDisplay: getElem('timer-display'),
        phaseDisplay: getElem('phase-display'),
        controlsContainer: getElem('controls-container'),
        startPauseBtn: getElem('start-pause-btn'),
        resetBtn: getElem('reset-btn'),
        settingsBtn: getElem('settings-btn'),
        closeSettingsBtn: getElem('close-settings-btn'),
        themesSettingsBtn: getElem('themes-settings-btn'),
        exerciseSettingsBtn: getElem('exercise-settings-btn'),
        backToSettingsFromThemesBtn: getElem('back-to-settings-from-themes-btn'),
        backToSettingsFromExercisesBtn: getElem('back-to-settings-from-exercises-btn'),
        setDurationDisplay: getElem('set-duration-display'),
        totalDurationDisplay: getElem('total-duration-display'),
        timerInputsContainer: getElem('timer-inputs-container'),
        settingsTogglesContainer: getElem('settings-toggles-container'),
        presetHeading: getElem('preset-heading'),
        savePresetModeBtn: getElem('save-preset-mode-btn'),
        presetButtonsContainer: getElem('preset-buttons-container'),
        themeButtonsContainer: getElem('theme-buttons-container'),
        exerciseInputsContainer: getElem('exercise-inputs-container'),
    };

    // --- STATE MANAGEMENT ---
    let state = {};
    let isSavingPreset = false;

    const themes = [
        { id: 'default', name: 'Default Dark' }, { id: 'forest', name: 'Forest' }, { id: 'ocean', name: 'Ocean' },
        { id: 'sunset', name: 'Sunset' }, { id: 'spring', name: 'Spring' }, { id: 'summer', name: 'Summer' },
        { id: 'winter', name: 'Winter' }, { id: 'desert', name: 'Desert' }, { id: 'jungle', name: 'Jungle' },
        { id: 'mountain', name: 'Mountain' }, { id: 'coast', name: 'Coast' }, { id: 'sakura', name: 'Sakura' },
    ];

    const soundFiles = {
        work: 'sound/work.mp3', rest: 'sound/rest.mp3', countdown: 'sound/countdown.mp3',
        setEnd: 'sound/set_end.mp3', finish: 'sound/finish.mp3'
    };
    let audioPlayers = {};
    let audioInitialized = false;

    const motivationalQuotes = [ 'MQ/quote1.mp3', 'MQ/quote2.mp3', 'MQ/quote3.mp3' ];
    let quotePlayers = [];
    let lastQuotePlayedTime = 0;
    let quoteTimer = null;

    const defaultState = {
        timer: null, status: 'idle', phase: 'prepare', currentTime: 0, currentRound: 0, currentSet: 0,
        settings: {
            workTime: 30, restTime: 15, roundsPerSet: 10, numSets: 5, restBetweenSets: 90, preStartDelay: 3,
            exercises: ["High Knees", "Burpees", "Jumping Jacks", "Mountain Climbers", "Jump Rope", "Tuck Jumps", "Skater Jumps", "Box Jumps", "Lunge Jumps", "Sprints"]
        },
        sounds: { preStart: 'countdown', workStart: 'work', restStart: 'rest', setEnd: 'setEnd', workoutComplete: 'finish' },
        presets: {
            "Main": { workTime: 35, restTime: 35, roundsPerSet: 8, numSets: 4, restBetweenSets: 40, exercises: ["Landmine row", "Landmine press", "Landmine squat", "Kettlebell swings"] },
            "More": { workTime: 32, restTime: 32, roundsPerSet: 3, numSets: 12, restBetweenSets: 0, exercises: ["Woodchoppers", "Bowman", "Shoulder 360s", "Face pulls", "Good mornings", "Reverse hyper", "Split squats", "Glute Circuit", "Hip flexor march", "Hamstring slides", "Push/Pull", "Neck/Forearms"] },
            "Thasmin": { workTime: 35, restTime: 35, roundsPerSet: 4, numSets: 7, restBetweenSets: 75, exercises: ["Kettlebell power cleans", "kettlebell swings", "split squat", "squat", "Hip thrust", "monster walk", "banded row"] },
            "1st": { workTime: 35, restTime: 35, roundsPerSet: 8, numSets: 4, restBetweenSets: 40, exercises: ["Barbell power cleans", "Barbell row", "Zercher squat", "Hip thrust"] },
            "2nd": { workTime: 32, restTime: 32, roundsPerSet: 3, numSets: 12, restBetweenSets: 0, exercises: ["Pull ups", "Push ups", "Pallof press", "Jefferson curls", "Back extension", "Suitcase carry", "Shoulder carry", "Monster walks", "3 Glutes", "Neck & forearms", "4-Plank", "YTWL"] },
            "Cardio": { workTime: 30, restTime: 15, roundsPerSet: 10, numSets: 5, restBetweenSets: 75, exercises: ["High Knees", "Burpees", "Jumping Jacks", "Mountain Climbers", "Jump Rope", "Tuck Jumps", "Skater Jumps", "Box Jumps", "Lunge Jumps", "Sprints"] }
        },
        theme: 'default',
        motivationalQuotesEnabled: true,
    };
    
    // --- DATA PERSISTENCE ---
    const saveState = () => {
        try {
            const stateToSave = { settings: state.settings, presets: state.presets, theme: state.theme, motivationalQuotesEnabled: state.motivationalQuotesEnabled };
            localStorage.setItem('tabataTimerState', JSON.stringify(stateToSave));
        } catch (e) { console.error("Could not save state", e); }
    };

    const loadState = () => {
        try {
            const savedStateJSON = localStorage.getItem('tabataTimerState');
            state = JSON.parse(JSON.stringify(defaultState));
            if (savedStateJSON) {
                const savedState = JSON.parse(savedStateJSON);
                if (savedState.settings) state.settings = { ...state.settings, ...savedState.settings };
                if (savedState.presets) state.presets = savedState.presets;
                if (savedState.theme) state.theme = savedState.theme;
                if (typeof savedState.motivationalQuotesEnabled === 'boolean') {
                    state.motivationalQuotesEnabled = savedState.motivationalQuotesEnabled;
                }
            }
        } catch (e) {
            console.error("Could not load state", e);
            state = JSON.parse(JSON.stringify(defaultState));
        }
        applyTheme(state.theme);
    };
    
    // --- DYNAMIC UI & THEME ---
    const applyTheme = (themeId) => {
        document.body.className = `theme-${themeId} bg-gray-900 text-white flex items-center justify-center min-h-screen p-4`;
        state.theme = themeId;
        saveState();
    };

    const generateThemeButtons = () => {
        const container = elements.themeButtonsContainer;
        container.innerHTML = '';
        themes.forEach(theme => {
            const button = document.createElement('button');
            button.dataset.themeId = theme.id;
            button.className = 'theme-btn w-full text-white font-bold py-3 px-4 rounded-lg text-lg btn';
            button.textContent = theme.name;
            button.style.backgroundColor = 'var(--bg-accent)';
            container.appendChild(button);
        });
    };

    const generateSettingsToggles = () => {
        const container = elements.settingsTogglesContainer;
        container.innerHTML = '';
        const checked = state.motivationalQuotesEnabled ? 'checked' : '';
        container.innerHTML = `
            <label class="toggle-label">
                <span class="font-medium" style="color: var(--text-primary);">Enable Motivational Quotes</span>
                <div class="toggle-switch">
                    <input type="checkbox" id="mq-toggle" ${checked}>
                    <span class="slider"></span>
                </div>
            </label>
        `;
    };

    const createStepperInput = (id, label, value, isFullWidth = false) => {
        const container = document.createElement('div');
        container.className = `form-group ${isFullWidth ? 'col-span-2' : ''}`;
        container.innerHTML = `
            <label for="${id}" class="block text-sm font-bold text-center" style="color: var(--text-secondary);">${label}</label>
            <div class="flex items-center gap-2 mt-1">
                <button data-action="decrement" data-target="${id}" class="stepper-btn w-10 h-10 text-xl font-bold rounded-md btn" style="background-color: var(--bg-tertiary); color: var(--text-primary);">-</button>
                <input type="number" id="${id}" value="${value}" class="timer-setting-input text-center block w-full border rounded-md shadow-sm py-2 px-3 focus:outline-none" style="background-color: var(--bg-primary); border-color: var(--bg-accent); color: var(--text-primary);">
                <button data-action="increment" data-target="${id}" class="stepper-btn w-10 h-10 text-xl font-bold rounded-md btn" style="background-color: var(--bg-tertiary); color: var(--text-primary);">+</button>
            </div>
        `;
        return container;
    };

    const generateTimerInputs = () => {
        const container = elements.timerInputsContainer;
        container.innerHTML = '';
        const s = state.settings;
        container.appendChild(createStepperInput('work-time', 'Work', s.workTime));
        container.appendChild(createStepperInput('rest-time', 'Rest', s.restTime));
        container.appendChild(createStepperInput('rounds-per-set', 'Rounds', s.roundsPerSet));
        container.appendChild(createStepperInput('num-sets', 'Sets', s.numSets));
        container.appendChild(createStepperInput('rest-between-sets', 'Rest Between Sets', s.restBetweenSets, true));
    };
    
    const generatePresetButtons = () => {
        const container = elements.presetButtonsContainer;
        container.innerHTML = '';
        Object.keys(state.presets).forEach(name => {
            const button = document.createElement('button');
            button.dataset.presetName = name;
            button.className = 'preset-btn text-white font-bold py-2 px-3 rounded-lg text-base btn truncate';
            button.textContent = name;
            button.style.backgroundColor = 'var(--btn-preset)';
            container.appendChild(button);
        });
    };

    const generateExerciseInputs = () => {
        const container = elements.exerciseInputsContainer;
        container.innerHTML = '';
        const numSets = state.settings.numSets;
        adjustExerciseArray(numSets); 
        for (let i = 0; i < numSets; i++) {
            const exerciseName = state.settings.exercises[i] || '';
            const inputGroup = document.createElement('div');
            inputGroup.innerHTML = `
                <label for="exercise-set-${i+1}" class="block text-sm font-medium" style="color: var(--text-secondary);">Set ${i+1}</label>
                <input type="text" id="exercise-set-${i+1}" data-set-index="${i}" value="${exerciseName}" class="exercise-input mt-1 block w-full border rounded-md shadow-sm py-2 px-3 focus:outline-none" style="background-color: var(--bg-tertiary); border-color: var(--bg-accent); color: var(--text-primary);">
            `;
            container.appendChild(inputGroup);
        }
    };

    // --- CORE TIMER FUNCTIONS ---
    const playSound = (soundType) => {
        if (soundType === 'countdown') {
            const countdownAudio = new Audio(soundFiles.countdown);
            countdownAudio.play().catch(e => console.error("Error playing countdown sound:", e));
            return;
        }
        const player = audioPlayers[soundType];
        if (player) {
            player.currentTime = 0;
            player.play().catch(e => console.error(`Error playing sound: ${soundType}`, e));
        }
    };

    const playRandomQuote = () => {
        if (quotePlayers.length === 0) return;
        const randomIndex = Math.floor(Math.random() * quotePlayers.length);
        const player = quotePlayers[randomIndex];
        if (player) {
            player.currentTime = 0;
            player.play().catch(e => console.error(`Error playing quote`, e));
            lastQuotePlayedTime = Date.now();
        }
    };
    
    const formatTime = (seconds) => {
        const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
        const secs = (seconds % 60).toString().padStart(2, '0');
        return `${mins}:${secs}`;
    };

    const tick = () => {
        state.currentTime--;
        updateDisplay();
        if (state.currentTime > 0) {
            if (state.phase === 'prepare') playSound(state.sounds.preStart);
            return;
        }
        if (state.phase === 'prepare') {
            state.phase = 'work'; state.currentRound = 1; state.currentSet = 1;
            state.currentTime = state.settings.workTime;
            playSound(state.sounds.workStart);
        } else if (state.phase === 'work') {
            if (state.currentRound >= state.settings.roundsPerSet && state.currentSet >= state.settings.numSets) {
                workoutComplete(); return;
            }
            state.phase = 'rest'; state.currentTime = state.settings.restTime;
            playSound(state.sounds.restStart);
        } else if (state.phase === 'rest') {
            if (state.currentRound >= state.settings.roundsPerSet) {
                 if (state.currentSet < state.settings.numSets && state.settings.restBetweenSets > 0) {
                    state.phase = 'setRest'; state.currentTime = state.settings.restBetweenSets;
                    playSound(state.sounds.setEnd);
                 } else {
                    state.currentSet++; state.currentRound = 1; state.phase = 'work';
                    state.currentTime = state.settings.workTime;
                    playSound(state.sounds.workStart);
                 }
            } else {
                state.currentRound++; state.phase = 'work';
                state.currentTime = state.settings.workTime;
                playSound(state.sounds.workStart);
            }
        } else if (state.phase === 'setRest') {
            state.currentSet++; state.currentRound = 1; state.phase = 'work';
            state.currentTime = state.settings.workTime;
            playSound(state.sounds.workStart);
        }
        updateDisplay();
    };
    
    const workoutComplete = () => {
        clearInterval(state.timer);
        clearInterval(quoteTimer);
        state.status = 'idle'; state.phase = 'complete';
        playSound(state.sounds.workoutComplete);
        elements.timerDisplayContent.classList.add('hidden');
        elements.completionMessage.classList.remove('hidden');
        updateButtonState();
        setTimeout(() => reset(true), 5000);
    };

    const start = () => {
        if (state.status === 'running') return;
        if (!audioInitialized) {
            const allAudioFiles = { ...soundFiles };
            motivationalQuotes.forEach((path, index) => {
                allAudioFiles[`quote${index}`] = path;
            });

            for (const key in allAudioFiles) {
                const player = new Audio(allAudioFiles[key]);
                player.volume = 0;
                player.play().catch(()=>{});
                setTimeout(() => {
                    player.pause();
                    player.currentTime = 0;
                    player.volume = 1;
                }, 10);
                if (key.startsWith('quote')) {
                    quotePlayers.push(player);
                } else {
                    audioPlayers[key] = player;
                }
            }
            audioInitialized = true;
        }
        if (state.status === 'idle' || state.phase === 'complete') {
            reset(false);
            state.phase = 'prepare';
            state.currentTime = state.settings.preStartDelay;
            if(state.settings.preStartDelay > 0) playSound(state.sounds.preStart);
        }
        state.status = 'running';
        lastQuotePlayedTime = Date.now();
        if (state.motivationalQuotesEnabled) {
            quoteTimer = setInterval(() => {
                if (state.status === 'running' && Date.now() - lastQuotePlayedTime > 180000) {
                    if (Math.random() < 0.1) { // Random chance to play
                        playRandomQuote();
                    }
                }
            }, 5000); // Check every 5 seconds
        }
        elements.timerDisplay.style.color = 'var(--color-prepare)';
        if (state.currentTime > 0) {
            state.timer = setInterval(tick, 1000);
        } else {
            tick(); state.timer = setInterval(tick, 1000);
        }
        updateButtonState();
        updateDisplay();
    };

    const pause = () => {
        if (state.status !== 'running') return;
        clearInterval(state.timer);
        clearInterval(quoteTimer);
        state.status = 'paused';
        updateButtonState();
    };

    const reset = (fullReset = true) => {
        clearInterval(state.timer);
        clearInterval(quoteTimer);
        state.status = 'idle';
        state.phase = 'prepare';
        state.currentRound = 0;
        state.currentSet = 0;
        state.currentTime = 0;
        if (fullReset) {
            elements.timerDisplayContent.classList.remove('hidden');
            elements.completionMessage.classList.add('hidden');
            updateButtonState();
            updateDisplay(true);
        }
    };

    // --- UI UPDATE FUNCTIONS ---
    const updateDurations = () => {
        const s = state.settings;
        const work = s.workTime || 0, rest = s.restTime || 0, rounds = s.roundsPerSet || 0,
              sets = s.numSets || 0, setRest = s.restBetweenSets || 0;
        const setDuration = (work * rounds) + (rest * (rounds > 1 ? rounds - 1 : 0));
        const totalDuration = (setDuration * sets) + (setRest * (sets > 1 ? sets - 1 : 0));
        elements.setDurationDisplay.textContent = formatTime(setDuration);
        elements.totalDurationDisplay.textContent = formatTime(totalDuration);
    };

    const updateDisplay = (isInitialReset = false) => {
        if (isInitialReset) {
            elements.phaseDisplay.textContent = "GET READY!";
            elements.timerDisplay.textContent = "--:--";
        } else {
            elements.timerDisplay.textContent = formatTime(state.currentTime);
            elements.phaseDisplay.textContent = state.phase.replace('setRest', 'SET REST');
        }
        
        elements.currentRoundDisplay.textContent = state.currentRound;
        elements.totalRoundsDisplay.textContent = state.settings.roundsPerSet;
        elements.currentSetDisplay.textContent = state.currentSet;
        elements.totalSetsDisplay.textContent = state.settings.numSets;
        elements.exerciseDisplay.textContent = (state.currentSet > 0 && state.settings.exercises[state.currentSet - 1]) ? state.settings.exercises[state.currentSet - 1] : '---';

        const phaseColorMap = {
            prepare: 'var(--color-prepare)', work: 'var(--color-work)',
            rest: 'var(--color-rest)', setRest: 'var(--color-set-rest)', complete: 'var(--text-primary)'
        };
        const color = phaseColorMap[state.phase] || 'var(--text-primary)';
        elements.timerDisplay.style.color = color;
        elements.phaseDisplay.style.color = color;
    };
    
    const updateButtonState = () => {
        const startBtn = elements.startPauseBtn;
        if (state.status === 'running') {
            elements.controlsContainer.className = 'flex justify-center';
            elements.resetBtn.classList.add('hidden');
            elements.settingsBtn.classList.add('hidden');
            startBtn.textContent = 'Pause';
            startBtn.style.backgroundColor = 'var(--bg-accent)';
        } else if (state.status === 'paused') {
            elements.controlsContainer.className = 'grid grid-cols-3 gap-4';
            elements.resetBtn.classList.remove('hidden');
            elements.settingsBtn.classList.remove('hidden');
            startBtn.textContent = 'Resume';
            startBtn.style.backgroundColor = 'var(--btn-start)';
        } else {
            elements.controlsContainer.className = 'grid grid-cols-3 gap-4';
            elements.resetBtn.classList.remove('hidden');
            elements.settingsBtn.classList.remove('hidden');
            startBtn.textContent = 'Start';
            startBtn.style.backgroundColor = 'var(--btn-start)';
        }
    };

    const updateUIFromState = () => {
        generateTimerInputs();
        generatePresetButtons();
        generateExerciseInputs();
        generateThemeButtons();
        generateSettingsToggles();
        updateDurations();
        reset(true);
    };

    // --- EVENT HANDLERS ---
    const handleStartPause = () => { (state.status === 'running') ? pause() : start(); };
    
    const adjustExerciseArray = (newSize) => {
        const currentExercises = state.settings.exercises;
        if (!Array.isArray(currentExercises)) state.settings.exercises = [];
        while (newSize > state.settings.exercises.length) state.settings.exercises.push('');
        state.settings.exercises.length = newSize;
    };

    const handleSettingsChange = (e) => {
        const oldNumSets = state.settings.numSets;
        const currentExercises = [...state.settings.exercises];
        state.settings = {
            workTime: parseInt(getElem('work-time').value, 10) || 0, restTime: parseInt(getElem('rest-time').value, 10) || 0,
            roundsPerSet: parseInt(getElem('rounds-per-set').value, 10) || 0, numSets: parseInt(getElem('num-sets').value, 10) || 0,
            restBetweenSets: parseInt(getElem('rest-between-sets').value, 10) || 0,
            preStartDelay: state.settings.preStartDelay, exercises: currentExercises
        };
        if (state.settings.numSets !== oldNumSets) {
            adjustExerciseArray(state.settings.numSets);
            generateExerciseInputs();
        }
        updateDurations();
        if (state.status === 'idle') reset(true);
        saveState();
    };
    
    const handleExerciseInputChange = (e) => {
        state.settings.exercises[parseInt(e.target.dataset.setIndex, 10)] = e.target.value;
        saveState();
    };

    const applyPreset = (presetName) => {
        const presetSettings = state.presets[presetName];
        if (!presetSettings) return;
        const cleanPresetSettings = {
            workTime: presetSettings.workTime, restTime: presetSettings.restTime, roundsPerSet: presetSettings.roundsPerSet,
            numSets: presetSettings.numSets, restBetweenSets: presetSettings.restBetweenSets,
            exercises: presetSettings.exercises || []
        };
        state.settings = { ...state.settings, ...cleanPresetSettings };
        updateUIFromState();
        saveState();
    };

    const savePreset = (presetName) => {
        const { workTime, restTime, roundsPerSet, numSets, restBetweenSets, exercises } = state.settings;
        const presetToSave = { workTime, restTime, roundsPerSet, numSets, restBetweenSets, exercises };
        state.presets[presetName] = JSON.parse(JSON.stringify(presetToSave));
        saveState();
        togglePresetSaveMode(false);
        generatePresetButtons();
    };

    const togglePresetSaveMode = (isSaving) => {
        isSavingPreset = isSaving;
        elements.presetButtonsContainer.querySelectorAll('.preset-btn').forEach(btn => btn.classList.toggle('saving', isSaving));
        elements.presetHeading.textContent = isSaving ? "Select Slot to Overwrite" : "Presets";
        elements.savePresetModeBtn.textContent = isSaving ? "Cancel" : "Save as Preset";
    };

    const showPanel = (panelToShow) => {
        [elements.timerContainer, elements.settingsPanel, elements.themesPanel, elements.exerciseSettingsPanel].forEach(panel => {
            panel.classList.toggle('hidden', panel !== panelToShow);
        });
    };
    
    const handleStepper = (event) => {
        const button = event.target.closest('[data-action]');
        if (!button) return;
        const input = getElem(button.dataset.target);
        if (!input) return;
        let value = parseInt(input.value, 10);
        input.value = Math.max(0, button.dataset.action === 'increment' ? value + 1 : value - 1);
        input.dispatchEvent(new Event('input', { bubbles: true }));
    };
    
    // --- EVENT LISTENERS BINDING---
    const addEventListeners = () => {
        elements.startPauseBtn.addEventListener('click', handleStartPause);
        elements.resetBtn.addEventListener('click', () => reset(true));
        elements.settingsBtn.addEventListener('click', () => showPanel(elements.settingsPanel));
        elements.closeSettingsBtn.addEventListener('click', () => showPanel(elements.timerContainer));
        elements.themesSettingsBtn.addEventListener('click', () => showPanel(elements.themesPanel));
        elements.exerciseSettingsBtn.addEventListener('click', () => showPanel(elements.exerciseSettingsPanel));
        elements.backToSettingsFromThemesBtn.addEventListener('click', () => showPanel(elements.settingsPanel));
        elements.backToSettingsFromExercisesBtn.addEventListener('click', () => showPanel(elements.settingsPanel));
        elements.savePresetModeBtn.addEventListener('click', () => togglePresetSaveMode(!isSavingPreset));
        elements.timerInputsContainer.addEventListener('click', e => { if (e.target.closest('[data-action]')) handleStepper(e); });
        elements.timerInputsContainer.addEventListener('input', e => { if (e.target.matches('.timer-setting-input')) handleSettingsChange(e); });
        elements.exerciseInputsContainer.addEventListener('input', e => { if (e.target.matches('.exercise-input')) handleExerciseInputChange(e); });
        elements.themeButtonsContainer.addEventListener('click', e => {
            const themeBtn = e.target.closest('.theme-btn');
            if (themeBtn) applyTheme(themeBtn.dataset.themeId);
        });
        elements.settingsTogglesContainer.addEventListener('change', e => {
            if (e.target.id === 'mq-toggle') {
                state.motivationalQuotesEnabled = e.target.checked;
                if (!state.motivationalQuotesEnabled) {
                    clearInterval(quoteTimer);
                }
                saveState();
            }
        });
    };

    // --- INITIALIZATION ---
    loadState();
    updateUIFromState();
    addEventListeners();
    showPanel(elements.timerContainer);
});
</script>
</body>
</html>
